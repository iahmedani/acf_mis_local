<!doctype html>
<html lang="en">

<head>
  <title>OTP Addmision</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
    crossorigin="anonymous">
  <!-- <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
    crossorigin="anonymous">
  <!-- <link rel="stylesheet" href="../fa5/css/fontawesome-all.min.css"> -->
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
  <link rel="stylesheet" href="../css/jsgrid-theme-followup.css">
</head>
<style>
  tbody>tr>td {
    padding: 0 !important;
    font-size: 12px !important;
  }

  thead {
    font-size: 12px !important;
    font-weight: bold !important;
  }

  #myForm {
    padding-top: 30px;
  }
</style>

<body>
  <header>
    <nav class="navbar navbar-light sticky-top flex-md-nowrap p-0" style="background-color: #e3f2fd;">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">
        <img src="../img/acf-logo.svg" style="height: 50px;" alt="">
      </a>
      <ul class="navbar-nav px-3">

      </ul>
    </nav>
  </header>
  <div class="container-fluid">

    <div class="row">
      <div class="form-group col-sm-2 ">
        <label for="province">Province</label>
        <select name="province" id="ddProvince" class="form-control form-control-sm">
          <option selected disabled>Choose</option>

        </select>
      </div>
      <div class="form-group col-sm-2 ">

        <label for="district">District</label>
        <select name="district" id="ddDistrict" class="form-control form-control-sm">
          <option selected disabled>Choose</option>
        </select>
      </div>
      <div class="form-group col-sm-2 ">

        <label for="Tehsil">Tehsil</label>
        <select name="Tehsil" id="ddTehsil" class="form-control form-control-sm">
          <option selected disabled>Choose</option>

        </select>
      </div>
      <div class="form-group col-sm-2 ">
        <label for="uc">UC</label>
        <select name="uc" id="ddUC" class="form-control form-control-sm">
          <option selected disabled>Choose</option>
        </select>
      </div>
      <div class="form-group col-sm-2">

        <label for="site_id" class="form-label">Site Name:</label>

        <select name="site_id" id="ddHealthHouse" class="form-control form-control-sm">
          <option value="">Select One</option>
        </select>
      </div>
      <div class="form-group col-sm-2">

        <label for="exit_date" class="form-label">Exit Date:</label>

        <input type="date" name="exit_date" id="exit_date" class="form-control form-control-sm">
      </div>
    </div>
    <!-- <div class="card">
        <div class="card-header">
          Patient List:
        </div>
        <div class="card-body"> -->
<div class="row">

  <div id="jsGrid" class="table-responsive col col-sm-4"></div>
  <div id="exitEntry" class="col-sm-8 border rounded">
    <form action="#!" id="myForm">
      <div class="row">
      <div class="form-group col-sm-2">
        <label for="p_name" class="form-label" >Patient Name:</label>
        <input type="text" id="p_name" name="p_name" class="form-control form-control-sm ">
        </div>
        <div class="form-group col-sm-2">
            <label for="gender" class="form-label">Gender:</label>
            <select name="gender" id="gender" class="form-control form-control-sm">
              <option value="" selected disabled>Select</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
      <div class="form-group col-sm-2">

        <label for="village" class="form-label" >Village:</label>
        <input type="text" id="village" name="village" class="form-control form-control-sm ">
        </div>
      <div class="form-group col-sm-2">

          <label for="exit_weight" class="form-label">Exit Weight:</label>
          <input type="number" id="exit_weight" name="exit_weight" class="form-control form-control-sm ">
          </div>
      <div class="form-group col col-sm-2">

          <label for="exit_muac" >Exit MUAC:</label>
          <input type="text" id="exit_muac"  name="exit_muac" class="form-control form-control-sm ">
</div>
<div class="form-group col col-sm-2">

    <label for="exit_reason" >Exit Reasons:</label>
   <select name="exit_reason" id="exit_reason" class="form-control form-control-sm">
     <option value=""disabled selected >Select</option>
     <option value="cured">Cured</option>
     <option value="defaulter">Defaulter</option>
     <option value="non_responder">Non Responder</option>
     <option value="death">Death</option>
     <option value="medical_transfer">Medical Transfer</option>
     <option value="moved_out">Moved Out</option>
     <option value="idp_return">IDP Return</option>
     <option value="infant_>_6">Infant &gt;6 Months</option>
   </select>
</div>
</div>
<div class="row">
    <div class="form-group col-sm-2">
      <label for="exit_ration1">Ration 1:</label>
      <select name="exit_ration1" class="form-control form-control-sm" id="exit_ration1">
        <option value="RUTF Sachets">RUTF Sachets</option>
        <option value="Amoxicillin">Amoxicillin</option>
        <option value="Folic Acid">Folic Acid</option>
        <option value="MM Sachets">MM Sachets</option>
        <option value="MM Tablets">MM Tablets</option>
        <option value="Mebendazole">Mebendazole</option>
        <option value="Meteronidazole">Meteronidazole</option>
        <option value="Paracetamol">Paracetamol</option>
        <option value="Chloroquine">Chloroquine</option>
        <option value="Zink">Zink</option>
        <option value="Tertacycline">Tertacycline</option>
        <option value="Benzyl Benzoate">Benzyl Benzoate</option>
        <option value="IYCF_Cups_and_Spoons">IYCF Cups &and; Spoons </option>
      </select>
    </div>
    <div class="form-group col-sm-2">
      <label for="exit_quantity1">Quantity:</label>
      <input type="number" name="exit_quantity1" id="exit_quantity1" class="form-control form-control-sm" min="0">
    </div>
    <div class="form-group col-sm-2">
      <label for="exit_ration2">Ration 2:</label>
      <select name="exit_ration2" class="form-control form-control-sm" id="exit_ration2">
        <option value="RUTF Sachets">RUTF Sachets</option>
        <option value="Amoxicillin">Amoxicillin</option>
        <option value="Folic Acid">Folic Acid</option>
        <option value="MM Sachets">MM Sachets</option>
        <option value="MM Tablets">MM Tablets</option>
        <option value="Mebendazole">Mebendazole</option>
        <option value="Meteronidazole">Meteronidazole</option>
        <option value="Paracetamol">Paracetamol</option>
        <option value="Chloroquine">Chloroquine</option>
        <option value="Zink">Zink</option>
        <option value="Tertacycline">Tertacycline</option>
        <option value="Benzyl Benzoate">Benzyl Benzoate</option>
        <option value="IYCF_Cups_and_Spoons">IYCF Cups &and; Spoons </option>
      </select>
    </div>
    <div class="form-group col-sm-2">
      <label for="exit_quantity2">Quantity:</label>
      <input type="number" name="exit_quantity2" id="exit_quantity2" class="form-control form-control-sm" min="0">
    </div>
    <div class="form-group col-sm-2">
      <label for="exit_ration3">Ration 3:</label>
      <select name="exit_ration3" class="form-control form-control-sm" id="exit_ration3">
        <option value="RUTF Sachets">RUTF Sachets</option>
        <option value="Amoxicillin">Amoxicillin</option>
        <option value="Folic Acid">Folic Acid</option>
        <option value="MM Sachets">MM Sachets</option>
        <option value="MM Tablets">MM Tablets</option>
        <option value="Mebendazole">Mebendazole</option>
        <option value="Meteronidazole">Meteronidazole</option>
        <option value="Paracetamol">Paracetamol</option>
        <option value="Chloroquine">Chloroquine</option>
        <option value="Zink">Zink</option>
        <option value="Tertacycline">Tertacycline</option>
        <option value="Benzyl Benzoate">Benzyl Benzoate</option>
        <option value="IYCF_Cups_and_Spoons">IYCF Cups &and; Spoons </option>
      </select>
    </div>
    <div class="form-group col-sm-2">
      <label for="exit_quantity3">Quantity:</label>
      <input type="number" name="exit_quantity3" id="exit_quantity3" class="form-control form-control-sm" min="0">
    </div>
    <input type="tex" name="otp_id" id="otp_id" hidden>
    
  </div>
<div class="row">
    <div class="form-group col-sm-2 float-right">

   <input type="submit" id="btnOtpExit" value="Save" class="btn btn-primary btn-block form-control form-control-sm">
  </div>

</div>
      </div>    
      
    </form>
  </div>
</div>
    <!-- </div> -->
    <!-- </div> -->
  </div>


  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
    crossorigin="anonymous"></script> -->

  <script>
    window.$ = window.jQuery = require('jquery');
    require('jquery-validation');
  </script>
  <script src="../bower_components/bootstrap/dist/js/bootstrap.bundle.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

  <script>
    (function ($) {
      $.fn.serializeFormJSON = function () {

        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
          if (o[this.name]) {
            if (!o[this.name].push) {
              o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
          } else {
            o[this.name] = this.value || '';
          }
        });
        return o;
      };
    })(jQuery);
    const ipc = require('electron').ipcRenderer;
    $('#myForm').validate();
    $('#myForm').on('submit', function (e) {
      if ($(this).valid()) {
        var formData = $(this).serializeFormJSON();
        var exit_date = $('#exit_date').val();
        formData.exit_date = exit_date;
        delete formData.p_name;
        delete formData.gender;
        delete formData.village;
        e.preventDefault();
        ipc.send('otpExit', formData);
        // $("#grid").jsGrid("refresh");
        
      }
    })

    $(function () {
      //Adding Row
      $('#addMore').on('click', function () {
        var data = $("#tb tr:eq(1)").clone(true).appendTo("#tb");
        data.find("input").val('');
      });
      $(document).on('click', '.remove', function () {
        var trIndex = $(this).closest("tr").index();
        if (trIndex > 1) {
          $(this).closest("tr").remove();
        } else {
          alert("Sorry!! Can't remove first row!");
        }
      });
      var datePickerId = document.getElementById('txtScrChildDate');
      datePickerId.max = new Date().toISOString().split("T")[0];
    });
    $(function () {
      ipc.send('getProvince');
      ipc.on('province', function (evt, province) {
        $('#ddProvince').children('option:not(:first)').remove();

        // $('#ddProvince').find('option:gt(0)').remove();
        province.province.forEach(el => {
          $('#ddProvince').append(`<option value="${el.id}">${el.provinceName}</option>`);
        })
      })
      $('#ddProvince').on('change', function () {
        var prov = $(this).val();
        ipc.send('getDistrict', prov)
        ipc.on('district', function (evt, district) {
          $('#ddDistrict').children('option:not(:first)').remove();
          district.district.forEach(el => {
            $('#ddDistrict').append(`<option value="${el.id}">${el.districtName}</option>`);
          })
        })
      })
      $('#ddDistrict').on('change', function () {
        var dist = $(this).val();
        ipc.send('getTehsil', dist)
        ipc.on('tehsil', function (evt, tehsil) {
          $('#ddTehsil').children('option:not(:first)').remove();
          tehsil.tehsil.forEach(el => {
            $('#ddTehsil').append(`<option value="${el.id}">${el.tehsilName}</option>`);
          })
        })
      })
      $('#ddTehsil').on('change', function () {
        var tehs = $(this).val();
        ipc.send('getUC', tehs)
        ipc.on('uc', function (evt, uc) {
          $('#ddUC').children('option:not(:first)').remove();
          uc.uc.forEach(el => {
            $('#ddUC').append(`<option value="${el.id}">${el.ucName}</option>`);
          })
        })
      })
      var ucForHH;
      $('#ddUC').on('change', function () {
        var ucs = $(this).val();
        ucForHH = ucs
        ipc.send('getHealthHouse', ucs)
        ipc.on('hh', function (evt, hh) {
          $('#ddHealthHouse').children('option:not(:first)').remove();
          hh.hh.forEach(el => {
            $('#ddHealthHouse').append(`<option value="${el.id}">${el.siteName}</option>`);
          })
        })
      })

      let xx = (site_id)=>{
        return new Promise((resolve, reject)=>{
          ipc.send('get', site_id);
          ipc.on('have', (e, result)=>{
            var s = {
              data: result.result,
              itemsCount: result.result.length
            }
            if(result.err){
              reject(result.err)
            }else{
              resolve(s)
            }
          })
        })
      }

      $('#ddHealthHouse').on('change', function () {
        var site_id = $(this).val();
        // 
        $("#jsGrid").jsGrid({
          height: "500px",
          width: "100%",
          // filtering: true,
          // inserting: true,
          editing: true,
          // sorting: true,
          paging: true,
          autoload: true,
          pageLoading: true, // this is the clue
          pageSize: 10,
          pageButtonCount: 5,
          deleteConfirm: "Do you really want to delete client?",
          controller: {
            loadData: function (filter) {
              console.log(filter)
              console.log('loaddata', site_id)
              return xx(site_id);
            },
            updateItem: function (item) {
              console.log('update')
              console.log(item);
              return addFollowup(item);
            },
            rowByItem: function(item){
              console.log(item);
            }
          },
          fields: [{
              name: "reg_id",
              title: "Reg #",
              type: "text",
              width: 50,
              editing: false
            }, {
              name: "p_name",
              title: "Name",
              type: "text",
              width: 100,
              editing: false
            }, {
              name: "f_or_h_name",
              title: "Husband Name",
              type: "text",
              width: 100,
              editing: false
            }, {
              name: "site_village",
              title: "Village",
              type: "text",
              width: 100,
              editing: false
            } 
          ],
          rowClick: function(args){
            this.editItem(args.item);
            var data = args.item;
            $('#p_name').val(data.p_name);
            $('#gender').val(data.gender);
            $('#village').val(data.site_village);
            $('#otp_id').val(data.otp_id);
            $('#exit_date').val(data.exit_date);
            $('#exit_weight').val(data.exit_weight);
            $('#exit_muac').val(data.exit_muac);
            $('#exit_ration1').val(data.exit_ration1);
            $('#exit_ration2').val(data.exit_ration2);
            $('#exit_ration3').val(data.exit_ration3);
            $('#exit_quantity1').val(data.quantity1);
            $('#exit_quantity2').val(data.quantity2);
            $('#exit_quantity3').val(data.quantity3);

            console.log(args.item);
          }
          // ,
          // onDataLoaded: function (data) {
          //   console.log(data);
          // },
          // onItemUpdating: function (args) {
          //   console.log('on Updating', args)
          // }, // before controller.updateItem
          // onItemUpdated: function (args) {
          //   console.log('on Updated', args)

          // }, // on done of controller.updateItem
        });
      })
    })
    ipc.on('resultSent', function (evt, result) {
      $('body').append(`<div class="alert alert-primary" role="alert">
 ${result.msg}
</div>`)
      setTimeout(location.reload(), 2000);
    });
  </script>

</body>

</html>